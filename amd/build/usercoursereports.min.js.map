{"version":3,"file":"usercoursereports.min.js","sources":["../src/usercoursereports.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for User Course Reports filter\n *\n * @copyright  2025 https://santoshmagar.com.np/\n * @author     santoshtmp7\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/ajax', 'core/str'], function($, Ajax, str) {\n    'use strict';\n\n    const filterAreaId = 'report-usercoursereports-filter-area';\n    const applyFilterBtnId = 'applyfilter';\n\n    /**\n     * Fetches and updates the report table via AJAX.\n     * @param {string} formquerystring\n     */\n    function getFilterReportTable(formquerystring) {\n        $('#' + filterAreaId).attr('aria-busy', 'true');\n        $('#' + applyFilterBtnId).prop('disabled', true);\n        $('#filter-loading-wrapper').show();\n        // Make AJAX call\n        const request = {\n            methodname: 'report_usercoursereports_get_report_table',\n            args: {querystring: formquerystring}\n        };\n        const ajaxrequest = Ajax.call([request])[0];\n        ajaxrequest.done(function(response) {\n            // Update report filter table content\n            if (response.status && response.reporttable) {\n                window.history.replaceState('', 'url', response.pageurl);\n                $('#' + filterAreaId).replaceWith(response.reporttable);\n            }\n            // Field validation and error\n            $('#usercoursereports-filter [id^=id_error_]').html('').hide();\n            if (!response.is_validated) {\n                const validationErrors = response.validation_errors || [];\n                validationErrors.forEach(element => {\n                    let errorContainer = $('#id_error_' + element.field);\n                    if (errorContainer.length) {\n                        errorContainer.html(element.error).show();\n                    }\n                });\n            }\n            // Error message show when status is false.\n            $('#error-response-message').remove();\n            if (!response.status && response.message) {\n                $('#' + filterAreaId).prepend(\n                    '<p id=\"error-response-message\" class=\"invalid-feedback\" style=\"display:block;\">' + response.message + '</p>'\n                );\n            }\n\n        });\n        ajaxrequest.fail(function(response) {\n            window.console.log(response);\n            $('#error-response-message').remove();\n            $('#' + filterAreaId).prepend(\n                '<p id=\"error-response-message\" class=\"invalid-feedback\" style=\"display:block;\">' + response.message + '</p>'\n            );\n        });\n        ajaxrequest.always(function() {\n            $('#' + filterAreaId).removeAttr('aria-busy');\n            $('#' + applyFilterBtnId).prop('disabled', false);\n            $('#filter-loading-wrapper').hide();\n        });\n    }\n\n    /**\n     * Check and handle course summary read more/less button toggle\n     */\n    function checkHandleCourseSummaryToggle() {\n        const readmorePromise = str.get_string('readmore', 'report_usercoursereports');\n        const showlessPromise = str.get_string('showless', 'report_usercoursereports');\n\n        Promise.all([readmorePromise, showlessPromise]).then(([readmoreText, showlessText]) => {\n            document.querySelectorAll(\".singlecoursedetails\").forEach(card => {\n                const summary = card.querySelector(\".course-summary\");\n                const btn = card.querySelector(\".readmore-btn\");\n\n                if (!summary || !btn) {\n                    return;\n                }\n\n                if (summary.scrollHeight > summary.clientHeight) {\n                    btn.classList.remove(\"d-none\");\n                }\n\n                btn.addEventListener(\"click\", () => {\n                    summary.classList.toggle(\"collapsed-summary\");\n                    btn.textContent = summary.classList.contains(\"collapsed-summary\")\n                        ? readmoreText\n                        : showlessText;\n                });\n            });\n        });\n\n    }\n\n\n    return {\n        init: function() {\n            // Remove .col-md-3 and .col-md-9 from divs inside .usercoursereports-filter-field\n            $('.usercoursereports-filter-field div.col-md-3, .usercoursereports-filter-field div.col-md-9').each(function() {\n                $(this).removeClass('col-md-3 col-md-9');\n            });\n\n            // Change per page field type from text to number\n            if (document.getElementById('id_perpage')) {\n                document.getElementById('id_perpage').setAttribute('type', 'number');\n            }\n\n            // Handle course summary read more/less button toggle\n            checkHandleCourseSummaryToggle();\n\n            // Filter on form submit\n            $('#usercoursereports-filter').on('submit', function(e) {\n                const clickedButton = $(this).find('input[type=submit]:focus').attr('name');\n                if (clickedButton !== 'cancel') {\n                    e.preventDefault();\n                    const formquerystring = $(this).serialize();\n                    getFilterReportTable(formquerystring);\n                }\n            });\n\n            // Filter on Pagination number click.\n            $(document).on('click', '#' + filterAreaId + ' nav.pagination a.page-link', function(e) {\n                e.preventDefault();\n                const formquerystring = $(this).attr('href').split('?')[1];\n                if (formquerystring) {\n                    getFilterReportTable(formquerystring);\n                }\n            });\n\n            // Filter on table column header for sorting click.\n            $(document).on('click', '#' + filterAreaId + ' thead th.header a[data-sortable=\"1\"]', function(e) {\n                e.preventDefault();\n                const formquerystring = $(this).attr('href').split('?')[1];\n                if (formquerystring) {\n                    getFilterReportTable(formquerystring);\n                }\n            });\n\n            // Filter the table on reset button click\n            $(document).on('click', '#' + filterAreaId + ' .resettable a', function(e) {\n                e.preventDefault();\n                const formquerystring = $(this).attr('href').split('?')[1];\n                if (formquerystring) {\n                    getFilterReportTable(formquerystring);\n                }\n            });\n\n            // Filter on single select field change\n            $('#usercoursereports-single-search select#id_id').on('change', function() {\n                var selectedValue = $(this).val();\n                if (selectedValue) {\n                    var form = $(this).closest('form');\n                    form.attr('data-form-dirty', false);\n                    form.submit();\n                }\n            });\n\n        }\n    };\n});\n"],"names":["define","$","Ajax","str","filterAreaId","getFilterReportTable","formquerystring","attr","prop","show","request","methodname","args","querystring","ajaxrequest","call","done","response","status","reporttable","window","history","replaceState","pageurl","replaceWith","html","hide","is_validated","validation_errors","forEach","element","errorContainer","field","length","error","remove","message","prepend","fail","console","log","always","removeAttr","init","each","this","removeClass","document","getElementById","setAttribute","readmorePromise","get_string","showlessPromise","Promise","all","then","_ref","readmoreText","showlessText","querySelectorAll","card","summary","querySelector","btn","scrollHeight","clientHeight","classList","addEventListener","toggle","textContent","contains","checkHandleCourseSummaryToggle","on","e","find","preventDefault","serialize","split","val","form","closest","submit"],"mappings":"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"}