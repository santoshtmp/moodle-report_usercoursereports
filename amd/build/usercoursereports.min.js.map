{"version":3,"file":"usercoursereports.min.js","sources":["../src/usercoursereports.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for User Course Reports filter\n *\n * @copyright  2025 https://santoshmagar.com.np/\n * @author     santoshtmp7\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/ajax', 'core/str'], function($, Ajax, str) {\n    'use strict';\n\n    const filterFormId = 'usercoursereports-filter';\n    const filterAreaId = 'report-usercoursereports-filter-area';\n    const applyFilterBtnId = 'applyfilter';\n\n    /**\n     * Fetches and updates the report table via AJAX.\n     * @param {string} formquerystring\n     * @param {bool} formdata\n     */\n    function getFilterReportTable(formquerystring, formdata) {\n        $('#' + filterAreaId).attr('aria-busy', 'true');\n        $('#' + applyFilterBtnId).prop('disabled', true);\n        $('#filter-loading-wrapper').show();\n        // Make AJAX call.\n        const request = {\n            methodname: 'report_usercoursereports_get_report_table',\n            args: {\n                querystring: formquerystring,\n                formdata: formdata,\n            }\n        };\n        const ajaxrequest = Ajax.call([request])[0];\n        ajaxrequest.done(function(response) {\n            // Update report filter table content.\n            if (response.status && response.reporttable) {\n                window.history.replaceState('', 'url', response.pageurl);\n                $('#' + filterAreaId).replaceWith(response.reporttable);\n            }\n            // Field validation and error.\n            $('#' + filterFormId + ' [id^=id_error_]').html('').hide();\n            if (!response.is_validated) {\n                const validationErrors = response.validation_errors || [];\n                validationErrors.forEach(element => {\n                    let errorContainer = $('#id_error_' + element.field);\n                    if (errorContainer.length) {\n                        errorContainer.html(element.error).show();\n                    }\n                });\n            }\n            // Error message show when status is false.\n            $('#error-response-message').remove();\n            if (!response.status && response.message) {\n                $('#' + filterAreaId).prepend(\n                    '<p id=\"error-response-message\" class=\"invalid-feedback\" style=\"display:block;\">' + response.message + '</p>'\n                );\n            }\n\n        });\n        ajaxrequest.fail(function(response) {\n            window.console.log(response);\n            $('#error-response-message').remove();\n            $('#' + filterAreaId).prepend(\n                '<p id=\"error-response-message\" class=\"invalid-feedback\" style=\"display:block;\">' + response.message + '</p>'\n            );\n        });\n        ajaxrequest.always(function() {\n            $('#' + filterAreaId).removeAttr('aria-busy');\n            $('#' + applyFilterBtnId).prop('disabled', false);\n            $('#filter-loading-wrapper').hide();\n        });\n    }\n\n    /**\n     * Single report usercoursereports btn toggle.\n     */\n    function usercoursereportsToggleBtn() {\n\n        // Toggle course detail content.\n        $(document).on('click', '.usercoursereports [aria-controls=\"reportgeneraldetailcontent\"]', function() {\n            const $icon = $(this).find('.fa');\n            if ($(this).attr('aria-expanded') === 'true') {\n                $icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');\n                $(this).attr('aria-expanded', false);\n            } else {\n                $icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');\n                $(this).attr('aria-expanded', true);\n            }\n        });\n\n        // Read more / show less for summary.\n        if (document.querySelector('.usercoursereports .readmore-btn')) {\n            const readmorePromise = str.get_string('readmore', 'report_usercoursereports');\n            const showlessPromise = str.get_string('showless', 'report_usercoursereports');\n            Promise.all([readmorePromise, showlessPromise]).then(([readmoreText, showlessText]) => {\n                document.querySelectorAll(\".usercoursereports\").forEach(card => {\n                    const summary = card.querySelector(\".course-summary\");\n                    const btn = card.querySelector(\".readmore-btn\");\n\n                    if (!summary || !btn) {\n                        return false;\n                    }\n\n                    if (summary.scrollHeight > summary.clientHeight) {\n                        btn.classList.remove(\"d-none\");\n                    }\n\n                    btn.addEventListener(\"click\", () => {\n                        summary.classList.toggle(\"collapsed-summary\");\n                        btn.textContent = summary.classList.contains(\"collapsed-summary\")\n                            ? readmoreText\n                            : showlessText;\n                    });\n                    return true;\n                });\n                return true;\n            }).catch(err => {\n                window.console.error(err);\n                return false;\n            });\n        }\n    }\n\n    /**\n     *\n     * @param {*} filterFormId\n     */\n    function formReset(filterFormId) {\n        const form = $(\"#\" + filterFormId);\n        if (!form.length) {\n            return false;\n        }\n\n        // Reset the native form.\n        form[0].reset();\n\n        // Clear autocomplete selections.\n        form.find(\".form-autocomplete-selection\").html('');\n\n        // Reset all fields inside wrappers.\n        form.find(\".usercoursereports-filter-field\").each(function() {\n            var $wrapper = $(this);\n            const selectDateEnableID = [\n                'id_startdatefrom_enabled',\n                'id_startdateto_enabled',\n                'id_createdfrom_enabled',\n                'id_createdto_enabled',\n            ];\n            $wrapper.find('input, select').each(function() {\n                var $el = $(this);\n                var type = $el.attr('type');\n                var id = $el.attr('id');\n                if ($el.is('select')) {\n                    if ($el.find('option[value=\"0\"]').length) {\n                        $el.val('0');\n                    } else if ($el.find('option[value=\"all\"]').length) {\n                        $el.val('all');\n                    }\n                } else if (type === 'checkbox') {\n                    if (selectDateEnableID.includes(id)) {\n                        $el.prop('checked', true);\n                        $el.parent().trigger('click');\n                    } else {\n                        $el.prop('checked', false);\n                    }\n                } else if (type === 'number') {\n                    $el.val($el.attr('default-value') || 50);\n                } else {\n                    $el.val('');\n                }\n            });\n        });\n        return true;\n    }\n\n    return {\n        init: function(pagedata) {\n            // Remove .col-md-3 and .col-md-9 from divs inside .usercoursereports-filter-field.\n            $('.usercoursereports-filter-field div.col-md-3, .usercoursereports-filter-field div.col-md-9').each(function() {\n                $(this).removeClass('col-md-3 col-md-9');\n            });\n\n            // Change per page field type from text to number.\n            if (document.getElementById('id_perpage')) {\n                document.getElementById('id_perpage').setAttribute('type', 'number');\n            }\n\n            // Handle course summary read more/less button toggle.\n            usercoursereportsToggleBtn();\n\n            // Remove name from autocomplete hidden field.\n            $('input[value=\"_qf__force_multiselect_submission\"]').each(function() {\n                $(this).val('');\n                $(this).attr('name', '');\n            });\n\n            // Filter on form submit.\n            $('#' + filterFormId).on('submit', function(e) {\n                const clickedButton = $(this).find('input[type=submit]:focus').attr('name');\n                if (clickedButton !== 'cancel') {\n                    e.preventDefault();\n                    const formquerystring = $(this).serialize();\n                    getFilterReportTable(formquerystring, true);\n                }\n            });\n\n            // Filter on Pagination number click.\n            $(document).on('click', '#' + filterAreaId + ' nav.pagination a.page-link', function(e) {\n                e.preventDefault();\n                const formquerystring = $(this).attr('href').split('?')[1];\n                if (formquerystring) {\n                    getFilterReportTable(formquerystring, false);\n                }\n            });\n\n            // Filter on table column header for sorting click.\n            $(document).on('click', '#' + filterAreaId + ' thead th.header a[data-sortable=\"1\"]', function(e) {\n                e.preventDefault();\n                const formquerystring = $(this).attr('href').split('?')[1];\n                if (formquerystring) {\n                    getFilterReportTable(formquerystring, false);\n                }\n            });\n\n            // Filter the table on reset link click.\n            $(document).on('click', '#' + filterAreaId + ' .resettable a', function(e) {\n                e.preventDefault();\n                const formquerystring = $(this).attr('href').split('?')[1];\n                if (formquerystring) {\n                    getFilterReportTable(formquerystring, false);\n                    return formReset(filterFormId);\n                }\n                return false;\n            });\n\n            // Filter the table clear btn click.\n            $(document).on('click', '#' + filterFormId + ' #clearfilter', function(e) {\n                let formquerystring = '';\n                if (pagedata.pagereseturl) {\n                    let url = new URL(pagedata.pagereseturl, window.location.origin);\n                    formquerystring = url.searchParams.toString();\n                }\n                if (formquerystring) {\n                    e.preventDefault();\n                    e.stopPropagation();\n                    e.stopImmediatePropagation();\n                    getFilterReportTable(formquerystring, false);\n                    return formReset(filterFormId);\n                }\n                return true;\n            });\n\n            // Filter on single select field change.\n            $('#usercoursereports-single-search #fitem_id_id').removeClass('mb-3');\n            $('#usercoursereports-single-search select#id_id').on('change', function() {\n                var selectedValue = $(this).val();\n                if (selectedValue) {\n                    var form = $(this).closest('form');\n                    setTimeout(function() {\n                        form.attr('data-form-dirty', false);\n                        form.submit();\n                    }, 0);\n                }\n                return true;\n            });\n\n            // On load user single detail load the course.\n            if (\n                $('.singleuserdetail.my-enrolled-courses #report-usercoursereports-filter-area').length ||\n                $('.singlecoursedetails.courseparticipation #report-usercoursereports-filter-area').length\n            ) {\n                let formquerystring = '';\n                if (pagedata.pagereseturl) {\n                    let url = new URL(pagedata.pagereseturl, window.location.origin);\n                    formquerystring = url.searchParams.toString();\n                }\n                if (formquerystring) {\n                    getFilterReportTable(formquerystring, false);\n                }\n            }\n\n        }\n    };\n});\n"],"names":["define","$","Ajax","str","filterFormId","filterAreaId","getFilterReportTable","formquerystring","formdata","attr","prop","show","request","methodname","args","querystring","ajaxrequest","call","done","response","status","reporttable","window","history","replaceState","pageurl","replaceWith","html","hide","is_validated","validation_errors","forEach","element","errorContainer","field","length","error","remove","message","prepend","fail","console","log","always","removeAttr","formReset","form","reset","find","each","$wrapper","this","selectDateEnableID","$el","type","id","is","val","includes","parent","trigger","init","pagedata","removeClass","document","getElementById","setAttribute","on","$icon","addClass","querySelector","readmorePromise","get_string","showlessPromise","Promise","all","then","_ref","readmoreText","showlessText","querySelectorAll","card","summary","btn","scrollHeight","clientHeight","classList","addEventListener","toggle","textContent","contains","catch","err","usercoursereportsToggleBtn","e","preventDefault","serialize","split","pagereseturl","URL","location","origin","searchParams","toString","stopPropagation","stopImmediatePropagation","closest","setTimeout","submit"],"mappings":"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"}